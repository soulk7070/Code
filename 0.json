# =================================================================
# üöÄ 1. INSTALASI SEMUA YANG DIBUTUHKAN
# =================================================================
!apt -y update -qq
!pip install -q xformers pyngrok

# Clone ComfyUI jika belum ada
import os
if not os.path.isdir("ComfyUI"):
  !git clone https://github.com/comfyanonymous/ComfyUI
%cd ComfyUI
!pip install -r requirements.txt

# Clone ComfyUI-Manager
if not os.path.isdir("custom_nodes/ComfyUI-Manager"):
  !git clone https://github.com/ltdrdata/ComfyUI-Manager.git custom_nodes/ComfyUI-Manager

# =================================================================
# üì¶ 2. DOWNLOAD MODEL (Jalankan hanya jika belum ada)
# =================================================================
# Buat folder jika belum ada
!mkdir -p models/checkpoints

# --- Download Model SDXL Base ---
!wget -c https://huggingface.co/stabilityai/stable-diffusion-xl-base-1.0/resolve/main/sd_xl_base_1.0.safetensors -P models/checkpoints/

# --- Download Model SDXL Refiner ---
!wget -c https://huggingface.co/stabilityai/stable-diffusion-xl-refiner-1.0/resolve/main/sd_xl_refiner_1.0.safetensors -P models/checkpoints/

# =================================================================
# üåê 3. JALANKAN COMFYUI & NGROK
# =================================================================
import subprocess
import threading
import time
from pyngrok import ngrok

# Masukkan Ngrok Token Anda di sini
NGROK_TOKEN = "MASUKKAN_TOKEN_KAMU_DI_SINI"  # üëà Ganti dengan token Anda

if not NGROK_TOKEN:
  print("‚ö†Ô∏è Harap masukkan Ngrok Auth Token Anda!")
else:
  ngrok.set_auth_token(NGROK_TOKEN)

  # Jalankan ComfyUI di background
  print("‚úÖ Memulai server ComfyUI...")
  process = subprocess.Popen(["python", "main.py", "--dont-print-server", "--port", "8188"])

  # Beri jeda 15 detik agar server ComfyUI siap
  print("‚è≥ Menunggu server siap selama 15 detik...")
  time.sleep(15)

  # Buka terowongan ngrok
  public_url = ngrok.connect(8188)
  print(f"üîó Akses ComfyUI WebUI Anda di sini: {public_url}")

