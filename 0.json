// Ambil semua item dari node sebelumnya (Split In Batches akan kirim 1 item per loop)
const items = $input.all();
if (items.length === 0) {
  $execution.stop();
  return [];
}

const i = items[0].json;

// Validasi prompt
const prompt = (i.prompt || '').toString().trim();
if (!prompt) {
  throw new Error('Prompt kosong atau tidak valid');
}

// Normalisasi ratio
const r = (i.ratio || 'landscape').toString().toLowerCase();
const ratioMap = {
  'landscape': '16:9',
  '16:9': '16:9',
  'portrait': '9:16',
  '9:16': '9:16',
  'square': '1:1',
  '1:1': '1:1'
};
const aspectRatio = ratioMap[r] || '16:9';

// Normalisasi durasi (boleh "8s" atau "8")
let d = (i.duration ?? '8').toString().toLowerCase().replace('s','').trim();
const durationSeconds = Number.parseInt(d, 10) || 8;

return [{
  json: {
    // Payload untuk HTTP node "Veo2 - Create"
    payload: {
      prompt,
      aspectRatio,
      durationSeconds
    },

    // Metadata untuk node berikutnya
    sheetRowNumber: i.rowNumber ?? i._row ?? null,
    rowId: i.id ?? null,
    originalRow: i
  }
}];
