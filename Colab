# =================================================================
# 🔄 JALANKAN ULANG SERVER COMFYUI (Cloudflare Tunnel)
# (Gunakan sel ini setelah menginstal custom node baru)
# =================================================================
import os
import re
import time
import shutil
import subprocess

def run(cmd, check=True):
    """Jalankan perintah shell singkat."""
    return subprocess.run(cmd, shell=True, check=check, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)

print("⏳ Menghentikan proses lama (ComfyUI & tunnel)...")

# Matikan ComfyUI lama (jika ada)
try:
    run("pkill -f 'main.py --dont-print-server --port 8188'", check=False)
except Exception:
    pass

# Matikan cloudflared lama (jika ada)
try:
    run("pkill -f cloudflared", check=False)
except Exception:
    pass

# Pastikan port bebas
time.sleep(3)
print("✅ Proses lama dihentikan.")

# -----------------------------------------------------------------
# 📦 Pastikan Cloudflare Tunnel (cloudflared) terpasang
# -----------------------------------------------------------------
if shutil.which("cloudflared") is None:
    print("⬇️ Mengunduh & memasang Cloudflare Tunnel...")
    # Paket .deb resmi, arsitektur x86_64 (sesuai runtime Colab)
    run("wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb")
    run("sudo dpkg -i cloudflared-linux-amd64.deb || sudo apt-get -y -qq install -f")
    if shutil.which("cloudflared") is None:
        raise RuntimeError("Gagal memasang cloudflared. Coba jalankan sel ini lagi.")

print("🚀 Menjalankan ulang ComfyUI...")
# Jalankan ComfyUI di background
server_proc = subprocess.Popen(
    ["python", "main.py", "--dont-print-server", "--port", "8188"],
    stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True
)

# Tunggu server siap
print("⏳ Menunggu server siap (±15 detik)...")
time.sleep(15)

# -----------------------------------------------------------------
# 🌐 Buka Cloudflare Tunnel (tanpa login, gratis & stabil)
# -----------------------------------------------------------------
print("🌐 Membuka Cloudflare Tunnel...")
tunnel_cmd = ["cloudflared", "tunnel", "--no-autoupdate", "--url", "http://127.0.0.1:8188"]
tunnel_proc = subprocess.Popen(tunnel_cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)

public_url = None
start_time = time.time()
url_pattern = re.compile(r"https://[a-z0-9-]+\.trycloudflare\.com", re.IGNORECASE)

# Baca output cloudflared untuk menangkap URL
print("⏳ Mengambil URL publik dari Cloudflare...")
while time.time() - start_time < 60:  # timeout 60 detik
    line = tunnel_proc.stdout.readline()
    if not line:
        time.sleep(0.5)
        continue
    match = url_pattern.search(line)
    if match:
        public_url = match.group(0)
        break

if public_url:
    print("\n🎉 Server ComfyUI berhasil dijalankan ulang! 🎉")
    print(f"🔗 Akses melalui link BARU ini:\n{public_url}\n")
else:
    print("\n⚠️ Tidak berhasil mendeteksi URL tunnel secara otomatis.")
    print("Namun tunnel kemungkinan tetap aktif. Coba cek log cloudflared di atas.")
    print("Jika belum muncul, hentikan sel dan jalankan ulang.")

# -----------------------------------------------------------------
# 🛑 Catatan:
# - Biarkan sel ini tetap berjalan agar tunnel aktif.
# - Jika ingin menghentikan: jalankan pkill seperti di atas atau restart runtime.
# -----------------------------------------------------------------
