#@title üöÄ A1111 + JuggernautXL v9 Rundiffusion Photo 2 + VAE + ngrok (1-click)
#@markdown 1) Isi token ngrok kamu di bawah, lalu jalankan cell ini sekali saja.
NGROK_TOKEN = "MASUKKAN_TOKEN_NGROK_DI_SINI"  #@param {type:"string"}

import os, subprocess, sys, time, textwrap

def sh(cmd):
    print(f"\n$ {cmd}")
    code = subprocess.call(cmd, shell=True, executable="/bin/bash")
    if code != 0:
        print(f"‚ö†Ô∏è Perintah exit code: {code}")
    return code

# 0) Update & deps
sh("apt -y update -qq && apt -y install -qq aria2")
sh("pip -q install pyngrok xformers==0.0.22.post7")

# 1) Clone A1111
if not os.path.exists("/content/stable-diffusion-webui"):
    sh("git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git /content/stable-diffusion-webui")
os.chdir("/content/stable-diffusion-webui")

# 2) Folder model & VAE
sh("mkdir -p /content/stable-diffusion-webui/models/Stable-diffusion")
sh("mkdir -p /content/stable-diffusion-webui/models/VAE")

# 3) Download MODEL (JuggernautXL v9 Rundiffusion Photo 2, SDXL)
MODEL_PATH = "/content/stable-diffusion-webui/models/Stable-diffusion/juggernautXL_v9Rundiffusionphoto2.safetensors"
if not os.path.exists(MODEL_PATH):
    sh(
        "aria2c -x16 -s16 -o juggernautXL_v9Rundiffusionphoto2.safetensors "
        "'https://civitai.com/api/download/models/348913?type=Model&format=SafeTensor&size=full&fp=fp16' "
        "-d /content/stable-diffusion-webui/models/Stable-diffusion"
    )
else:
    print("‚úÖ Model sudah ada, lewati download.")

# 4) Download VAE (SDXL VAE FP16 FIX)
VAE_PATH = "/content/stable-diffusion-webui/models/VAE/sdxl_vae.safetensors"
if not os.path.exists(VAE_PATH):
    sh(
        "aria2c -x16 -s16 -o sdxl_vae.safetensors "
        "https://huggingface.co/madebyollin/sdxl-vae-fp16-fix/resolve/main/sdxl_vae.safetensors "
        "-d /content/stable-diffusion-webui/models/VAE"
    )
else:
    print("‚úÖ VAE sudah ada, lewati download.")

# 5) Siapkan argumen launch A1111
os.environ["TF_CPP_MIN_LOG_LEVEL"] = "3"
os.environ["COMMANDLINE_ARGS"] = (
    "--xformers "
    "--enable-insecure-extension-access "
    "--no-half-vae "          # aman untuk SDXL VAE fp16 fix
    "--opt-sdp-attention "
    "--listen --port 7860"
)

# 6) Jalankan A1111 di background
print("\n‚ñ∂Ô∏è Menjalankan Stable Diffusion WebUI‚Ä¶")
webui_log = open("/content/webui.log", "w")
proc = subprocess.Popen(
    [sys.executable, "launch.py"],
    stdout=webui_log, stderr=webui_log, cwd="/content/stable-diffusion-webui"
)

# 7) Tunggu server siap (cek port 7860)
import socket
def wait_port(host="127.0.0.1", port=7860, timeout=180):
    t0 = time.time()
    while time.time() - t0 < timeout:
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.settimeout(2)
        try:
            s.connect((host, port))
            s.close()
            return True
        except:
            time.sleep(2)
    return False

ready = wait_port()
if not ready:
    print("‚ö†Ô∏è WebUI belum siap dalam 3 menit, lanjut buka ngrok tetap‚Ä¶ (cek /content/webui.log jika perlu)")

# 8) Buka ngrok
from pyngrok import ngrok
if NGROK_TOKEN and NGROK_TOKEN != "MASUKKAN_TOKEN_NGROK_DI_SINI":
    try:
        ngrok.set_auth_token(NGROK_TOKEN)
        public_url = ngrok.connect(7860)
        print("\nüîó Akses Stable Diffusion WebUI (AUTOMATIC1111):")
        print(public_url)
        print("\nüìù Catatan:")
        print("- Pilih checkpoint: juggernautXL_v9Rundiffusionphoto2.safetensors")
        print("- VAE: sdxl_vae.safetensors (otomatis terdeteksi), jika perlu pilih di Settings ‚Üí SD VAE.")
        print("- Log server: /content/webui.log")
    except Exception as e:
        print(f"‚ùå Gagal membuka ngrok: {e}\nPastikan token benar.")
else:
    print("‚ö†Ô∏è NGROK_TOKEN kosong. Edit variabel di atas lalu jalankan ulang cell ini untuk mendapatkan URL publik.")
