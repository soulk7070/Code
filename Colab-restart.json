# =================================================================
# 🔄 JALANKAN ULANG SERVER COMFYUI
# (Gunakan sel ini setelah menginstal custom node baru)
# =================================================================
import subprocess
import time
from pyngrok import ngrok

print("⏳ Menghentikan server ComfyUI dan tunnel ngrok yang sedang berjalan...")

# Perintah untuk mematikan proses ComfyUI yang berjalan sebelumnya
# Ini akan mencari proses python yang menjalankan main.py di port 8188 dan mematikannya
!kill $(ps aux | grep '[m]ain.py --dont-print-server --port 8188' | awk '{print $2}') > /dev/null 2>&1

# Mematikan semua tunnel ngrok yang aktif
ngrok.kill()

# Beri jeda 5 detik untuk memastikan port sudah benar-benar bebas
time.sleep(5)

print("✅ Proses lama berhasil dihentikan.")
print("🚀 Memulai ulang server ComfyUI...")

# Menjalankan kembali ComfyUI di background
process = subprocess.Popen(["python", "main.py", "--dont-print-server", "--port", "8188"])

# Beri jeda 15 detik agar server siap
print("⏳ Menunggu server siap selama 15 detik...")
time.sleep(15)

# Membuat tunnel ngrok baru
public_url = ngrok.connect(8188)
print("🎉 Server berhasil dijalankan ulang! 🎉")
print(f"🔗 Akses kembali melalui link BARU ini: {public_url}")

    
