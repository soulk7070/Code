# SEL 1


# === Kaggle Cell 1: System setup & ComfyUI base install ===
# Workdir Kaggle
cd /kaggle/working

# (Opsional) update & libGL untuk UI/preview
apt -y update -qq
apt -y install -qq libgl1-mesa-glx wget git

# Clone ComfyUI
if [ ! -d "ComfyUI" ]; then
  git clone https://github.com/comfyanonymous/ComfyUI.git
fi
cd ComfyUI

# Install PyTorch (CUDA 12.1 build cocok untuk T4/L4 di Kaggle) + deps ComfyUI
pip install --upgrade pip
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
pip install -r requirements.txt

# Cek GPU
python - << 'PY'
import torch
print("‚úÖ CUDA available:", torch.cuda.is_available())
print("üí° GPU device:", torch.cuda.get_device_name(0) if torch.cuda.is_available() else "None")
PY



=======================¬•œÄ¬•œÄ¬•‚Ä¢^¬∞œÄœÄ¬•¬•‚Ñ¢=¬∞^[]√∑‚úì`=`=‚Ç¨[‚Ç¨[‚Ç¨

# SEL 2


# === Kaggle Cell 2: Workspace & symlinks (no Google Drive) ===
set -e

# Lokasi kerja Kaggle
export COMFY_DIR="/kaggle/working/ComfyUI"
export BASE_DIR="/kaggle/working/ComfyData"

# Buat folder dasar & subfolder yang dibutuhkan ComfyUI
mkdir -p "$BASE_DIR"/models/{checkpoints,controlnet,vae,upscale_models,clip,unet}
mkdir -p "$BASE_DIR"/{custom_nodes,input,output,temp,user}

echo "‚úÖ Workspace folders created at: $BASE_DIR"

# Hapus folder/link lama di dalam repo ComfyUI (kalau ada), lalu buat symlink baru
for name in models custom_nodes input output temp user; do
  target="$BASE_DIR/$name"
  link="$COMFY_DIR/$name"
  if [ -L "$link" ] || [ -d "$link" ]; then
    rm -rf "$link"
  fi
  ln -s "$target" "$link"
  echo "üîó Linked $link -> $target"
done

echo "‚úÖ ComfyUI is now configured to use Kaggle workspace storage."


======================¬•œÄ¬•œÄ¬•‚Ä¢^¬∞œÄœÄ¬•¬•‚Ñ¢=¬∞^[]√∑‚úì`=`=‚Ç¨[‚Ç¨[‚Ç¨

# === Kaggle Cell 3 (updated): Download batch upscale folders ===
pip install -q gdown

# Lokasi input untuk batch upscale
INPUT_DIR="/kaggle/working/ComfyData/input"
mkdir -p "$INPUT_DIR"

# Download folder up1
gdown --folder "https://drive.google.com/drive/folders/1E0Kkh2PA_ZY8RpQXBuTMDIcg5gRZX4Gh?usp=sharing" -O "$INPUT_DIR/up1"

# Download folder up2
gdown --folder "https://drive.google.com/drive/folders/17xgALN3fbz5O_YDCi8eAHtNnaHiKrbYv?usp=sharing" -O "$INPUT_DIR/up2"

# Download folder up3
gdown --folder "https://drive.google.com/drive/folders/1_iBbAPHZLukpYijf9vPiBBYqP9_5tSah?usp=sharing" -O "$INPUT_DIR/up3"

echo "‚úÖ Semua folder sudah berhasil diunduh ke $INPUT_DIR"
ls -R "$INPUT_DIR"




  
##################


# SEL 3

# === Kaggle Cell 3 (fix): Download models from HuggingFace ===
import os

HF_TOKEN = ""  # üîë isi kalau perlu private repo
BASE_DIR = "/kaggle/working/ComfyData/models"

paths = {
    # Diffusion model (Flux)
    "diffusion": {
        "filename": "flux1-dev-Q4_0.gguf",
        "url": "https://huggingface.co/city96/FLUX.1-dev-gguf/resolve/main/flux1-dev-Q4_0.gguf?download=true",
        "folder": "diffusion_models"
    },
    # CLIP encoders
    "clip_t5_q5": {
        "filename": "t5-v1_1-xxl-encoder-Q5_K_M.gguf",
        "url": "https://huggingface.co/city96/t5-v1_1-xxl-encoder-gguf/resolve/main/t5-v1_1-xxl-encoder-Q5_K_M.gguf?download=true",
        "folder": "clip"
    },
    "clip_t5_q4": {
        "filename": "t5-v1_1-xxl-encoder-Q4_K_S.gguf",
        "url": "https://huggingface.co/city96/t5-v1_1-xxl-encoder-gguf/resolve/main/t5-v1_1-xxl-encoder-Q4_K_S.gguf?download=true",
        "folder": "clip"
    },
    "clip_l": {
        "filename": "clip_l.safetensors",
        "url": "https://huggingface.co/comfyanonymous/flux_text_encoders/resolve/main/clip_l.safetensors?download=true",
        "folder": "clip"
    },
    # VAE
    "vae": {
        "filename": "ae.safetensors",
        "url": "https://huggingface.co/Comfy-Org/Lumina_Image_2.0_Repackaged/resolve/main/split_files/vae/ae.safetensors?download=true",
        "folder": "vae"
    },
    # Upscale model
    "upscale": {
        "filename": "4x_NMKD-Siax_200k.pth",
        "url": "https://huggingface.co/Akumetsu971/SD_Anime_Futuristic_Armor/resolve/main/4x_NMKD-Siax_200k.pth?download=true",
        "folder": "upscale_models"
    }
}

for key, data in paths.items():
    folder_path = os.path.join(BASE_DIR, data["folder"])
    file_path = os.path.join(folder_path, data["filename"])
    os.makedirs(folder_path, exist_ok=True)
    if not os.path.exists(file_path):
        print(f"‚¨áÔ∏è Downloading {data['filename']}...")
        !wget --header="Authorization: Bearer $HF_TOKEN" -O "{file_path}" "{data['url']}"
    else:
        print(f"‚úÖ {data['filename']} already exists, skipping.")





#######2222222222222222######


# SEL 4

# === Kaggle Cell 4: Install Custom Nodes ===
cd /kaggle/working/ComfyUI/custom_nodes

# ComfyUI Manager (biar gampang update node)
rm -rf ComfyUI-Manager
git clone https://github.com/ltdrdata/ComfyUI-Manager.git

# Tambahan custom nodes
git clone https://github.com/rgthree/rgthree-comfy.git
git clone https://github.com/yolain/ComfyUI-Easy-Use.git
git clone https://github.com/ltdrdata/was-node-suite-comfyui.git
git clone https://github.com/ltdrdata/ComfyUI-Impact-Pack.git
git clone https://github.com/city96/ComfyUI-GGUF.git
git clone https://github.com/shiimizu/ComfyUI-TiledDiffusion.git

echo "‚úÖ Semua custom nodes berhasil di-clone."



######‚Ññ##########$$$$######‚Ññ$####‚Ññ###


# SEL 5

# === Kaggle Cell 5: Setup Ngrok Tunnel ===
cd /kaggle/working

# Bersihkan dulu kalau ada sisa file ngrok lama
rm -f ngrok ngrok.zip ngrok-stable-linux-amd64.tgz

# Download ngrok versi Linux AMD64
wget -O ngrok-stable-linux-amd64.tgz https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
tar -xvzf ngrok-stable-linux-amd64.tgz
chmod +x ngrok

# üîë Masukkan token ngrok kamu di sini
./ngrok authtoken 31SHA7EHRu2DlbH0oEdGWTzHfeF_4c2RHUkeuQU6nJxuYvDLG

# Cek versi ngrok untuk memastikan berhasil
./ngrok version


======================¬•œÄ¬•œÄ¬•‚Ä¢^¬∞œÄœÄ¬•¬•‚Ñ¢=¬∞^[]√∑‚úì`=`=‚Ç¨[‚Ç¨[‚Ç¨



# SEL 6


# === Kaggle Cell 6: Run ngrok & get public URL ===
import subprocess, time, requests

# Jalankan ngrok di background untuk port 8188 (ComfyUI)
ngrok_process = subprocess.Popen(
    ['./ngrok', 'http', '8188'],
    stdout=subprocess.DEVNULL,
    stderr=subprocess.STDOUT
)

# Tunggu sampai ngrok siap (cek max 10x)
public_url = None
for i in range(10):
    try:
        r = requests.get('http://localhost:4040/api/tunnels')
        tunnels = r.json().get('tunnels')
        if tunnels:
            public_url = tunnels[0]['public_url']
            print(f"‚úÖ Ngrok tunnel established: {public_url}")
            break
    except Exception:
        print(f"‚è≥ Attempt {i+1}/10: Ngrok not ready yet...")
        time.sleep(2)

if not public_url:
    print("‚ùå Ngrok failed to start. Restart notebook and try again.")



&####$$#$$$###$$$##@-#-#


# === Kaggle Cell 7: Run ComfyUI (foreground) ===
cd /kaggle/working/ComfyUI

# Jalankan ComfyUI di foreground (sel akan terus berputar)
python main.py --listen 0.0.0.0 --port 8188 --cuda-device 0


